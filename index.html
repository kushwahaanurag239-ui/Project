<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nabha Telemedicine ‚Äî Prototype</title>

  <!-- jsPDF for e-prescription PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{--brand:#2a9d8f;--accent:#e76f51;--muted:#6c757d}
    body{font-family:Inter, system-ui, Arial; margin:0;background:#f6f8fa;color:#222}
    header{background:linear-gradient(90deg,var(--brand),#264653);color:#fff;padding:18px 20px}
    .container{max-width:1100px;margin:26px auto;padding:18px}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
    .card{background:#fff;border-radius:10px;padding:14px;box-shadow:0 6px 20px rgba(10,10,10,0.06)}
    #chatbox{height:420px;display:flex;flex-direction:column}
    #messages{flex:1;overflow:auto;padding:8px}
    .msg{margin:8px 0}
    .msg.user{text-align:right}
    .msg .bubble{display:inline-block;padding:8px 12px;border-radius:14px;max-width:78%}
    .msg.user .bubble{background:var(--brand);color:#fff}
    .msg.bot .bubble{background:#eef4f3;color:#111}
    .chat-controls{display:flex;gap:8px;margin-top:8px}
    input[type=text]{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd}
    button{padding:10px 12px;border:none;border-radius:8px;background:var(--brand);color:#fff;cursor:pointer}
    .mini{background:#fff;color:var(--brand);border:1px solid #ddd}
    .section-title{font-weight:700;margin-bottom:8px}
    .appt-list{list-style:none;padding:0;margin:0}
    .appt-item{padding:8px;border-bottom:1px dashed #eee}
    footer{padding:18px;text-align:center;color:var(--muted)}
    @media (max-width:900px){.grid{grid-template-columns:1fr}#chatbox{height:320px}}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 style="margin:0">Nabha Telemedicine ‚Äî Prototype</h1>
      <div style="font-size:13px;margin-top:6px;opacity:.9">Multilanguage AI chatbot ‚Ä¢ e-Prescription ‚Ä¢ Video consult (demo) ‚Ä¢ ABHA placeholder</div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <div>
        <div class="card">
          <h2 class="section-title">Patient Quick Actions</h2>

          <!-- ABHA / Signup -->
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
            <input id="abha" placeholder="Enter ABHA ID (demo)" style="padding:10px;border-radius:8px;border:1px solid #ddd;flex:1" />
            <button id="btnLogin" onclick="demoSignup()">Login</button>
          </div>

          <!-- Appointment form -->
          <div style="margin-bottom:14px">
            <h3 style="margin:6px 0">Book Appointment</h3>
            <form id="apptForm" onsubmit="return false">
              <input id="pname" placeholder="Patient name" style="width:100%;padding:8px;margin-bottom:6px;border-radius:6px;border:1px solid #eee" required />
              <input id="psymptom" placeholder="Symptoms / Short note" style="width:100%;padding:8px;margin-bottom:6px;border-radius:6px;border:1px solid #eee" required />
              <div style="display:flex;gap:8px">
                <input id="pdate" type="date" style="padding:8px;border-radius:6px;border:1px solid #eee;flex:1" required />
                <select id="slot" style="padding:8px;border-radius:6px;border:1px solid #eee">
                  <option>10:00 AM</option>
                  <option>11:00 AM</option>
                  <option>02:00 PM</option>
                  <option>04:00 PM</option>
                </select>
              </div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button onclick="bookAppt()">Book</button>
                <button class="mini" onclick="openVideoDemo()" type="button">Start Video Demo</button>
              </div>
            </form>
          </div>

          <!-- E-Prescription -->
          <div style="margin-bottom:12px">
            <h3 style="margin:6px 0">e-Prescription (Demo)</h3>
            <input id="drugname" placeholder="Medicine & dose (e.g. Paracetamol 500mg)" style="width:100%;padding:8px;margin-bottom:6px;border-radius:6px;border:1px solid #eee" />
            <input id="docname" placeholder="Doctor name" style="width:100%;padding:8px;margin-bottom:6px;border-radius:6px;border:1px solid #eee" />
            <div style="display:flex;gap:8px">
              <button onclick="generatePDF()">Generate PDF</button>
              <button class="mini" onclick="downloadDemoRecord()" type="button">Download Health Record</button>
            </div>
          </div>

          <!-- IoT / Pharmacy quick -->
          <div>
            <h3 style="margin:6px 0">Pharmacy / IoT (Demo)</h3>
            <div style="font-size:13px;color:var(--muted)">Simulated device readings & nearby pharmacy suggestion</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button onclick="simulateIOT()">Simulate BP/Glucose</button>
              <button class="mini" onclick="findPharmacy()">Find Nearby Pharmacy</button>
            </div>
          </div>
        </div>

        <!-- Chatbot card -->
        <div class="card" style="margin-top:16px">
          <h2 class="section-title">AI Chatbot (Hindi / Punjabi / English)</h2>
          <div id="chatbox">
            <div id="messages" aria-live="polite">
              <div class="msg bot"><div class="bubble">‡§®‡§Æ‡§∏‡•ç‡§§‡•á üôè ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å ‚Äî symptoms ‡§¨‡§§‡§æ‡§è‡§Ç ‡§Ø‡§æ "help" ‡§≤‡§ø‡§ñ‡•á‡§Ç.</div></div>
            </div>

            <div class="chat-controls">
              <input id="chatInput" type="text" placeholder="Type in Hindi / Punjabi / English" onkeydown="if(event.key==='Enter') sendChat()" />
              <button onclick="startVoice()">üé§</button>
              <button onclick="sendChat()">Send</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right column -->
      <aside>
        <div class="card">
          <h3 class="section-title">Upcoming Appointments</h3>
          <ul id="appts" class="appt-list"></ul>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 class="section-title">Doctor / Admin (Demo)</h3>
          <div style="font-size:13px;color:var(--muted)">Login as doctor to view appointments and generate prescriptions.</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="docLogin" placeholder="Doctor code" style="flex:1;padding:8px;border-radius:6px;border:1px solid #eee" />
            <button onclick="docLogin()">Login</button>
          </div>
          <div id="doctorPanel" style="display:none;margin-top:10px;background:#fbfbfb;padding:8px;border-radius:6px">
            <div style="font-weight:700">Doctor Dashboard (Demo)</div>
            <div style="font-size:13px;color:var(--muted);margin-top:6px">Select appointment and click "Generate Prescription".</div>
            <select id="selectAppt" style="width:100%;margin-top:8px;padding:8px;border-radius:6px;border:1px solid #eee"></select>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="prescText" placeholder="Prescription text" style="flex:1;padding:8px;border-radius:6px;border:1px solid #eee" />
              <button onclick="docGeneratePresc()">Generate</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 class="section-title">System Notes</h3>
          <ul style="font-size:13px;color:var(--muted)">
            <li>Data saved locally (demo). Connect to real backend for production.</li>
            <li>ABHA integration requires NDHM APIs and consent flow (not included).</li>
            <li>Video demo uses browser media only ‚Äî production needs WebRTC server or 3rd party SDK.</li>
          </ul>
        </div>
      </aside>

    </div>
  </main>

  <footer>
    ¬© Nabha Telemedicine Prototype ‚Äî Demo for learning
  </footer>

  <script>
    // API base: set to backend when you run server locally:
    // const API_BASE = 'http://localhost:4000/api';
    const API_BASE = '';

    // --- Simple local storage demo for appointments ---
    const apptsKey = 'nabha_appts_v1';
    const msgsEl = document.getElementById('messages');
    const apptsList = document.getElementById('appts');
    const selectAppt = document.getElementById('selectAppt');

    function loadAppts(){
      const arr = JSON.parse(localStorage.getItem(apptsKey) || '[]');
      apptsList.innerHTML = '';
      selectAppt.innerHTML = '<option value="">-- select --</option>';
      arr.forEach((a,i)=>{
        const li = document.createElement('li'); li.className='appt-item';
        li.innerHTML = `<strong>${a.name}</strong><div style="font-size:13px;color:${getComputedStyle(document.documentElement).getPropertyValue('--muted')}">${a.date} ‚Ä¢ ${a.slot}<div style="font-size:12px;color:var(--muted)">Note: ${a.symptom}</div></div>`;
        apptsList.appendChild(li);
        const opt = document.createElement('option'); opt.value = i; opt.textContent = `${a.name} ‚Äî ${a.date} ${a.slot}`; selectAppt.appendChild(opt);
      })
    }
    loadAppts();

    function bookAppt(){
      const name = document.getElementById('pname').value.trim();
      const symptom = document.getElementById('psymptom').value.trim();
      const date = document.getElementById('pdate').value;
      const slot = document.getElementById('slot').value;
      if(!name || !symptom || !date) return alert('Please fill required fields');
      const arr = JSON.parse(localStorage.getItem(apptsKey) || '[]');
      arr.push({name,symptom,date,slot});
      localStorage.setItem(apptsKey,JSON.stringify(arr));
      loadAppts();
      alert('Appointment booked (demo)');
      document.getElementById('pname').value=''; document.getElementById('psymptom').value='';
      // Optionally: send to backend
      // if(API_BASE) fetch(`${API_BASE}/appts`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name,symptom,date,slot})});
    }

    // --- PDF generation using jsPDF ---
    async function generatePDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const patient = (document.getElementById('pname').value) || 'Patient Name';
      const med = document.getElementById('drugname').value || 'Medicine details';
      const docn = document.getElementById('docname').value || 'Dr. Demo';
      doc.setFontSize(16); doc.text('e-Prescription', 14, 20);
      doc.setFontSize(12); doc.text(`Patient: ${patient}`, 14, 36);
      doc.text(`Doctor: ${docn}`, 14, 44);
      doc.text(`Prescription: ${med}`, 14, 52);
      doc.save('prescription.pdf');
    }

    function downloadDemoRecord(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text('Demo Health Record - Nabha Telemedicine',14,20);
      doc.text('This is a sample record for demo purposes',14,32);
      doc.save('health-record.pdf');
    }

    // --- Simulated IoT & Pharmacy ---
    function simulateIOT(){
      const bp = 90 + Math.floor(Math.random()*50);
      const sugar = 80 + Math.floor(Math.random()*80);
      addBotMsg(`Simulated Device Readings: BP: ${bp} mmHg, Glucose: ${sugar} mg/dL`);
    }
    function findPharmacy(){
      addBotMsg('Nearest pharmacies: Ravi Pharmacy (2.1 km), Kaur Medical (3.5 km) ‚Äî (demo)');
    }

    // --- Doctor demo login ---
    function docLogin(){
      const code = document.getElementById('docLogin').value.trim();
      if(code === 'doc123'){ document.getElementById('doctorPanel').style.display='block'; loadAppts(); alert('Doctor logged in (demo)'); }
      else alert('Invalid doctor code (use doc123 for demo)');
    }
    function docGeneratePresc(){
      const idx = selectAppt.value; if(idx==='') return alert('Select appointment');
      const arr = JSON.parse(localStorage.getItem(apptsKey) || '[]'); const ap = arr[Number(idx)];
      const text = document.getElementById('prescText').value || 'Take medicines as advised.';
      document.getElementById('pname').value = ap.name;
      document.getElementById('drugname').value = text;
      document.getElementById('docname').value = 'Dr. Demo (Telemedicine)';
      generatePDF();
    }

    // --- Video demo (local only) ---
    let localStream;
    async function openVideoDemo(){
      try{
        const s = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
        localStream = s;
        const w = window.open('','videoDemo','width=720,height=540');
        w.document.title = 'Video Demo ‚Äî Local Preview';
        w.document.body.innerHTML = `<h3 style="font-family:Arial">Video Demo (local) ‚Äî No remote peer</h3><video autoplay playsinline muted style="width:100%;max-width:700px;border:1px solid #ddd;border-radius:6px"></video><div style="margin-top:8px"><button id=stop>Stop</button></div>`;
        const video = w.document.querySelector('video'); video.srcObject = s;
        w.document.getElementById('stop').onclick = ()=>{ s.getTracks().forEach(t=>t.stop()); w.close(); };
      }catch(e){alert('Camera access denied or unavailable');}
    }

    // --- Simple multilingual chatbot (local demo) ---
    function detectLanguage(text){
      if(/[\u0A00-\u0A7F]/.test(text)) return 'punjabi';
      if(/[\u0900-\u097F]/.test(text)) return 'hindi';
      return 'english';
    }

    function addUserMsg(txt){
      const p = document.createElement('div'); p.className='msg user'; p.innerHTML = `<div class="bubble">${escapeHtml(txt)}</div>`; msgsEl.appendChild(p); msgsEl.scrollTop = msgsEl.scrollHeight;
    }
    function addBotMsg(txt){
      const p = document.createElement('div'); p.className='msg bot'; p.innerHTML = `<div class="bubble">${escapeHtml(txt)}</div>`; msgsEl.appendChild(p); msgsEl.scrollTop = msgsEl.scrollHeight;
    }
    function escapeHtml(unsafe) { return unsafe.replace(/[&<>"']/g, function(m) { return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]; }); }

    async function sendChat(){
      const input = document.getElementById('chatInput'); const text = input.value.trim(); if(!text) return;
      addUserMsg(text); input.value='';
      const lang = detectLanguage(text);
      // If backend API is set and you implemented /chatbot, you can call it:
      if(API_BASE){
        try{
          const res = await fetch(`${API_BASE}/chatbot`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
          const data = await res.json();
          addBotMsg(data.reply || 'Sorry, no reply');
          return;
        }catch(e){
          // fallback to local rules
        }
      }

      if(/(bukhar|bukh(a)?r|fever)/i.test(text) || /\u092c\u0915\u093e\u0930/.test(text)){
        if(lang==='hindi') addBotMsg('Agar bukhar 2 din se zyada hai toh doctor se consult karein. Pahle paracetamol len aur paani zyada piyen.');
        else if(lang==='punjabi') addBotMsg('‡®ú‡©á ‡®¨‡©Å‡®ñ‡®æ‡®∞ 2 ‡®¶‡®ø‡®® ‡®§‡©ã‡®Ç ‡®µ‡©±‡®ß ‡®π‡©à ‡®§‡®æ‡®Ç ‡®°‡®æ‡®ï‡®ü‡®∞ ‡®®‡©Ç‡©∞ ‡®¶‡®ø‡®ñ‡®æ‡®ì‡•§ ‡®™‡®∞‡®æ‡®∏‡©Ä‡®ü‡®æ‡®Æ‡©ã‡®≤ ‡®≤‡©ã ‡®Ö‡®§‡©á ‡®™‡®æ‡®£‡©Ä ‡®ú‡®º‡®ø‡®Ü‡®¶‡®æ ‡®™‡©Ä‡®ì‡•§');
        else addBotMsg('If fever >2 days, please consult a doctor. Take paracetamol and stay hydrated.');
      } else if(/(help|madad|‡®∏‡®π‡®æ‡®á‡®§‡®æ)/i.test(text)){
        if(lang==='hindi') addBotMsg('Main appointment book karne, nearby pharmacy dikhane aur doctor se connect karne me madad kar sakta hu.');
        else if(lang==='punjabi') addBotMsg('‡®Æ‡©à‡®Ç ‡®Ö‡®™‡®æ‡®á‡©∞‡®ü‡®Æ‡©à‡®Ç‡®ü, ‡®´‡®æ‡®∞‡®Æ‡©á‡®∏‡©Ä ‡®Ö‡®§‡©á ‡®°‡®æ‡®ï‡®ü‡®∞ ‡®®‡®æ‡®≤ ‡®ï‡®®‡©à‡®ï‡®ü ‡®ï‡®∞‡®® ‡®µ‡®ø‡©±‡®ö ‡®Æ‡®¶‡®¶ ‡®ï‡®∞ ‡®∏‡®ï‡®¶‡®æ ‡®π‡®æ‡®Ç‡•§');
        else addBotMsg('I can help book appointments, find pharmacies, or connect to a doctor.');
      } else {
        if(lang==='hindi') addBotMsg('‡§Ü‡§™‡§®‡•á ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§≤‡§ø‡§ñ‡§æ ‚Äî ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ (short) ‡§≤‡§ø‡§ñ‡•á‡§Ç ‡§Ø‡§æ "help" ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§');
        else if(lang==='punjabi') addBotMsg('‡®§‡©Å‡®∏‡©Ä‡®Ç ‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä ‡®µ‡®ø‡©±‡®ö ‡®≤‡®ø‡®ñ‡®ø‡®Ü ‚Äî ‡®Ü‡®™‡®£‡©Ä ‡®∏‡®Æ‡©±‡®∏‡®ø‡®Ü ‡®≤‡®ø‡®ñ‡©ã ‡®ú‡®æ‡®Ç "help" ‡®≤‡®ø‡®ñ‡©ã‡•§');
        else addBotMsg('You wrote in English ‚Äî type your symptoms or "help".');
      }
    }

    // --- Speech recognition (voice input) ---
    let recognition;
    function startVoice(){
      if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return alert('Speech recognition not supported in this browser');
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR(); recognition.lang = 'hi-IN'; recognition.interimResults=false; recognition.maxAlternatives=1;
      recognition.onresult = (e)=>{ const t = e.results[0][0].transcript; document.getElementById('chatInput').value = t; sendChat(); };
      recognition.onerror = (e)=>{ alert('Voice error: '+e.error); }
      recognition.start();
    }

    // Demo signup / login (frontend mock)
    function demoSignup(){
      const abha = document.getElementById('abha').value.trim();
      if(!abha) return alert('Enter ABHA (demo)');
      alert('Logged in as demo ABHA: ' + abha);
    }

    // Helper: initial fill demo
    (function seedDemo(){
      if(!localStorage.getItem(apptsKey)){
        const now = new Date(); now.setDate(now.getDate()+2);
        const d = now.toISOString().slice(0,10);
        const demo = [{name:'Sita Devi',symptom:'Bukhar aur khaansi',date:d,slot:'10:00 AM'}];
        localStorage.setItem(apptsKey,JSON.stringify(demo));
      }
      loadAppts();
    })();
  </script>
</body>
</html>